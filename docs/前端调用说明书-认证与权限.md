# 前端调用说明书 - 认证与权限模块

本文档为 Vue3 前端开发者提供登录/注册功能和用户权限验证组件的 API 调用指南。

---

## 目录

- [1. 概述](#1-概述)
- [2. 环境配置](#2-环境配置)
- [3. API 接口说明](#3-api-接口说明)
- [4. TypeScript 类型定义](#4-typescript-类型定义)
- [5. API 封装实现](#5-api-封装实现)
- [6. Vue3 组件示例](#6-vue3-组件示例)
- [7. 权限验证组件](#7-权限验证组件)
- [8. 错误处理](#8-错误处理)

---

## 1. 概述

### 1.1 服务信息

| 项目 | 值 |
|------|-----|
| 后端服务地址 | `http://localhost:8000` |
| API 版本 | `v1` |
| API 前缀 | `/api/v1` |
| 认证方式 | JWT Bearer Token |
| Token 有效期 | 24 小时（默认） |

### 1.2 统一响应格式

所有 API 返回统一的 JSON 格式：

```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

错误响应：

```json
{
  "code": 400,
  "message": "错误信息（中文）",
  "data": null
}
```

参数验证错误 (422)：

```json
{
  "code": 422,
  "message": "用户名长度不足",
  "errors": [
    {"field": "username", "message": "用户名长度不足"}
  ]
}
```

---

## 2. 环境配置

### 2.1 安装依赖

```bash
# 使用 pnpm
pnpm add axios pinia @vueuse/core

# 或使用 npm
npm install axios pinia @vueuse/core
```

### 2.2 环境变量配置

```env
# .env.development
VITE_API_BASE_URL=http://localhost:8000
VITE_API_PREFIX=/api/v1
```

```env
# .env.production
VITE_API_BASE_URL=https://api.your-domain.com
VITE_API_PREFIX=/api/v1
```

---

## 3. API 接口说明

### 3.1 用户注册

**POST** `/api/v1/auth/register`

**请求体：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | ✅ | 用户名，3-50 字符 |
| password | string | ✅ | 密码，至少 8 位，必须包含大写字母、小写字母和数字 |
| email | string | ❌ | 邮箱地址 |
| real_name | string | ❌ | 真实姓名 |
| school | string | ❌ | 学校 |
| major | string | ❌ | 专业 |

**密码强度要求：**
- 至少 8 位字符
- 必须包含大写字母 (A-Z)
- 必须包含小写字母 (a-z)
- 必须包含数字 (0-9)

**请求示例：**

```json
{
  "username": "zhangsan",
  "password": "Password123",
  "email": "zhangsan@example.com",
  "real_name": "张三",
  "school": "北京大学",
  "major": "计算机科学"
}
```

**成功响应：**

```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "username": "zhangsan",
    "email": "zhangsan@example.com",
    "real_name": "张三",
    "avatar_url": null,
    "role": "user",
    "status": "active",
    "created_at": "2026-02-14T15:08:00Z"
  }
}
```

**错误响应：**

| HTTP 状态码 | 错误信息 |
|------------|---------|
| 400 | 用户名已存在 |
| 400 | 邮箱已被注册 |
| 400 | 密码必须包含大写字母 |
| 400 | 密码必须包含小写字母 |
| 400 | 密码必须包含数字 |
| 422 | 参数验证失败 |

---

### 3.2 用户登录

**POST** `/api/v1/auth/login`

**请求体：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | ✅ | 用户名 |
| password | string | ✅ | 密码 |
| device_type | string | ❌ | 设备类型，默认 "web" |

**请求示例：**

```json
{
  "username": "zhangsan",
  "password": "password123",
  "device_type": "web"
}
```

**成功响应：**

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 86400,
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "username": "zhangsan",
      "email": "zhangsan@example.com",
      "real_name": "张三",
      "avatar_url": null,
      "role": "user",
      "status": "active",
      "created_at": "2026-02-14T15:08:00Z"
    }
  }
}
```

**错误响应：**

| HTTP 状态码 | 错误信息 |
|------------|---------|
| 401 | 用户名或密码错误 |
| 403 | 账号已被禁用 |

---

### 3.3 用户登出

**POST** `/api/v1/auth/logout`

**请求头：**

```
Authorization: Bearer <access_token>
```

**成功响应：**

```json
{
  "code": 200,
  "message": "登出成功",
  "data": null
}
```

---

### 3.4 获取当前用户信息

**GET** `/api/v1/auth/me`

**请求头：**

```
Authorization: Bearer <access_token>
```

**成功响应：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "username": "zhangsan",
    "email": "zhangsan@example.com",
    "real_name": "张三",
    "avatar_url": null,
    "role": "user",
    "status": "active",
    "created_at": "2026-02-14T15:08:00Z"
  }
}
```

**错误响应：**

| HTTP 状态码 | 错误信息 |
|------------|---------|
| 401 | Token 无效或已过期 |

---

### 3.5 修改密码

**POST** `/api/v1/auth/password/change`

**请求头：**

```
Authorization: Bearer <access_token>
```

**请求体：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| old_password | string | ✅ | 旧密码 |
| new_password | string | ✅ | 新密码，至少 8 位，必须包含大小写字母和数字 |

**请求示例：**

```json
{
  "old_password": "OldPassword123",
  "new_password": "NewPassword456"
}
```

**成功响应：**

```json
{
  "code": 200,
  "message": "密码修改成功",
  "data": null
}
```

**错误响应：**

| HTTP 状态码 | 错误信息 |
|------------|---------|
| 400 | 旧密码错误 |
| 422 | 新密码不符合要求 |

---

## 4. TypeScript 类型定义

创建 `src/types/auth.ts`：

```typescript
// ============ 请求类型 ============

/** 用户注册请求 */
export interface RegisterRequest {
  username: string
  password: string
  email?: string
  real_name?: string
  school?: string
  major?: string
}

/** 用户登录请求 */
export interface LoginRequest {
  username: string
  password: string
  device_type?: 'web' | 'mobile' | 'desktop'
}

/** 修改密码请求 */
export interface ChangePasswordRequest {
  old_password: string
  new_password: string
}

// ============ 响应类型 ============

/** 用户信息 */
export interface User {
  id: string
  username: string
  email: string | null
  real_name: string | null
  avatar_url: string | null
  role: 'user' | 'admin'
  status: 'active' | 'inactive' | 'banned'
  created_at: string
}

/** Token 响应 */
export interface TokenResponse {
  access_token: string
  refresh_token: string
  token_type: string
  expires_in: number
  user: User
}

/** 统一 API 响应格式 */
export interface ApiResponse<T = any> {
  code: number
  message: string
  data: T
}

/** 用户画像 */
export interface UserProfile {
  id: string
  user_id: string
  target_positions: string[] | null
  skill_tags: Record<string, any> | null
  technical_score: number
  expression_score: number
  logic_score: number
  comprehensive_score: number
  total_interviews: number
  total_questions_answered: number
}
```

---

## 5. API 封装实现

### 5.1 Axios 实例配置

创建 `src/utils/request.ts`：

```typescript
import axios, { AxiosError, InternalAxiosRequestConfig, AxiosResponse } from 'axios'
import { useAuthStore } from '@/stores/auth'
import router from '@/router'

const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL + import.meta.env.VITE_API_PREFIX,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 请求拦截器 - 自动添加 Token
request.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    const authStore = useAuthStore()
    if (authStore.token) {
      config.headers.Authorization = `Bearer ${authStore.token}`
    }
    return config
  },
  (error: AxiosError) => {
    return Promise.reject(error)
  }
)

// 响应拦截器 - 统一错误处理
request.interceptors.response.use(
  (response: AxiosResponse) => {
    return response.data
  },
  (error: AxiosError<{ message: string; detail?: any }>) => {
    const authStore = useAuthStore()
    
    if (error.response) {
      const { status, data } = error.response
      
      switch (status) {
        case 401:
          // Token 过期，清除登录状态并跳转登录页
          authStore.logout()
          router.push('/login')
          break
        case 403:
          // 权限不足
          console.error('权限不足:', data.message)
          break
        case 422:
          // 参数验证失败
          console.error('参数验证失败:', data.detail)
          break
        default:
          console.error('请求错误:', data.message)
      }
    } else if (error.request) {
      console.error('网络错误，请检查网络连接')
    }
    
    return Promise.reject(error)
  }
)

export default request
```

### 5.2 认证 API 模块

创建 `src/api/auth.ts`：

```typescript
import request from '@/utils/request'
import type {
  RegisterRequest,
  LoginRequest,
  ChangePasswordRequest,
  User,
  TokenResponse,
  ApiResponse
} from '@/types/auth'

const AUTH_PREFIX = '/auth'

/** 用户注册 */
export function register(data: RegisterRequest): Promise<ApiResponse<User>> {
  return request.post(`${AUTH_PREFIX}/register`, data)
}

/** 用户登录 */
export function login(data: LoginRequest): Promise<ApiResponse<TokenResponse>> {
  return request.post(`${AUTH_PREFIX}/login`, data)
}

/** 用户登出 */
export function logout(): Promise<ApiResponse<null>> {
  return request.post(`${AUTH_PREFIX}/logout`)
}

/** 获取当前用户信息 */
export function getCurrentUser(): Promise<ApiResponse<User>> {
  return request.get(`${AUTH_PREFIX}/me`)
}

/** 修改密码 */
export function changePassword(data: ChangePasswordRequest): Promise<ApiResponse<null>> {
  return request.post(`${AUTH_PREFIX}/password/change`, data)
}
```

### 5.3 Pinia 认证状态管理

创建 `src/stores/auth.ts`：

```typescript
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { login as apiLogin, logout as apiLogout, getCurrentUser } from '@/api/auth'
import type { User, LoginRequest, TokenResponse } from '@/types/auth'

const TOKEN_KEY = 'access_token'
const REFRESH_TOKEN_KEY = 'refresh_token'
const USER_KEY = 'user_info'

export const useAuthStore = defineStore('auth', () => {
  // State
  const token = ref<string | null>(localStorage.getItem(TOKEN_KEY))
  const refreshToken = ref<string | null>(localStorage.getItem(REFRESH_TOKEN_KEY))
  const user = ref<User | null>(
    localStorage.getItem(USER_KEY) ? JSON.parse(localStorage.getItem(USER_KEY)!) : null
  )

  // Getters
  const isLoggedIn = computed(() => !!token.value)
  const isAdmin = computed(() => user.value?.role === 'admin')
  const username = computed(() => user.value?.username || '')

  // Actions
  /** 登录 */
  async function login(loginData: LoginRequest): Promise<TokenResponse> {
    const response = await apiLogin(loginData)
    const data = response.data

    // 保存 Token 和用户信息
    token.value = data.access_token
    refreshToken.value = data.refresh_token
    user.value = data.user

    localStorage.setItem(TOKEN_KEY, data.access_token)
    localStorage.setItem(REFRESH_TOKEN_KEY, data.refresh_token)
    localStorage.setItem(USER_KEY, JSON.stringify(data.user))

    return data
  }

  /** 登出 */
  async function logout(): Promise<void> {
    try {
      if (token.value) {
        await apiLogout()
      }
    } catch (error) {
      // 忽略登出错误，继续清除本地状态
    } finally {
      clearAuth()
    }
  }

  /** 清除认证状态 */
  function clearAuth(): void {
    token.value = null
    refreshToken.value = null
    user.value = null

    localStorage.removeItem(TOKEN_KEY)
    localStorage.removeItem(REFRESH_TOKEN_KEY)
    localStorage.removeItem(USER_KEY)
  }

  /** 刷新用户信息 */
  async function fetchUserInfo(): Promise<User> {
    const response = await getCurrentUser()
    user.value = response.data
    localStorage.setItem(USER_KEY, JSON.stringify(response.data))
    return response.data
  }

  /** 检查 Token 是否有效 */
  async function checkAuth(): Promise<boolean> {
    if (!token.value) return false

    try {
      await fetchUserInfo()
      return true
    } catch {
      clearAuth()
      return false
    }
  }

  return {
    // State
    token,
    refreshToken,
    user,
    // Getters
    isLoggedIn,
    isAdmin,
    username,
    // Actions
    login,
    logout,
    clearAuth,
    fetchUserInfo,
    checkAuth
  }
})
```

---

## 6. Vue3 组件示例

### 6.1 登录组件

创建 `src/views/LoginView.vue`：

```vue
<script setup lang="ts">
import { ref, reactive } from 'vue'
import { useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import type { LoginRequest } from '@/types/auth'

const router = useRouter()
const authStore = useAuthStore()

const loading = ref(false)
const errorMsg = ref('')

const loginForm = reactive<LoginRequest>({
  username: '',
  password: '',
  device_type: 'web'
})

async function handleLogin() {
  if (!loginForm.username || !loginForm.password) {
    errorMsg.value = '请输入用户名和密码'
    return
  }

  loading.value = true
  errorMsg.value = ''

  try {
    await authStore.login(loginForm)
    // 登录成功，跳转到首页或之前的页面
    const redirect = router.currentRoute.value.query.redirect as string
    router.push(redirect || '/')
  } catch (error: any) {
    errorMsg.value = error.response?.data?.message || '登录失败，请重试'
  } finally {
    loading.value = false
  }
}
</script>

<template>
  <div class="login-container">
    <div class="login-card">
      <h2>用户登录</h2>
      
      <form @submit.prevent="handleLogin">
        <div class="form-group">
          <label for="username">用户名</label>
          <input
            id="username"
            v-model="loginForm.username"
            type="text"
            placeholder="请输入用户名"
            :disabled="loading"
          />
        </div>

        <div class="form-group">
          <label for="password">密码</label>
          <input
            id="password"
            v-model="loginForm.password"
            type="password"
            placeholder="请输入密码"
            :disabled="loading"
          />
        </div>

        <div v-if="errorMsg" class="error-message">
          {{ errorMsg }}
        </div>

        <button type="submit" :disabled="loading" class="login-btn">
          {{ loading ? '登录中...' : '登录' }}
        </button>
      </form>

      <div class="login-footer">
        <router-link to="/register">还没有账号？立即注册</router-link>
      </div>
    </div>
  </div>
</template>

<style scoped>
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.login-card {
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  width: 100%;
  max-width: 400px;
}

.login-card h2 {
  text-align: center;
  margin-bottom: 30px;
  color: #333;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #555;
}

.form-group input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
}

.error-message {
  color: #e74c3c;
  font-size: 14px;
  margin-bottom: 16px;
  padding: 10px;
  background: #fdf0ed;
  border-radius: 6px;
}

.login-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.3s;
}

.login-btn:hover:not(:disabled) {
  opacity: 0.9;
}

.login-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.login-footer {
  text-align: center;
  margin-top: 20px;
}

.login-footer a {
  color: #667eea;
  text-decoration: none;
}
</style>
```

### 6.2 注册组件

创建 `src/views/RegisterView.vue`：

```vue
<script setup lang="ts">
import { ref, reactive } from 'vue'
import { useRouter } from 'vue-router'
import { register } from '@/api/auth'
import type { RegisterRequest } from '@/types/auth'

const router = useRouter()

const loading = ref(false)
const errorMsg = ref('')
const successMsg = ref('')

const registerForm = reactive<RegisterRequest>({
  username: '',
  password: '',
  email: '',
  real_name: '',
  school: '',
  major: ''
})

const confirmPassword = ref('')

async function handleRegister() {
  // 表单验证
  if (!registerForm.username || !registerForm.password) {
    errorMsg.value = '请填写用户名和密码'
    return
  }

  if (registerForm.password.length < 8) {
    errorMsg.value = '密码长度至少为 8 位'
    return
  }

  if (registerForm.password !== confirmPassword.value) {
    errorMsg.value = '两次输入的密码不一致'
    return
  }

  loading.value = true
  errorMsg.value = ''

  try {
    await register(registerForm)
    successMsg.value = '注册成功！即将跳转到登录页...'
    
    setTimeout(() => {
      router.push('/login')
    }, 2000)
  } catch (error: any) {
    errorMsg.value = error.response?.data?.message || '注册失败，请重试'
  } finally {
    loading.value = false
  }
}
</script>

<template>
  <div class="register-container">
    <div class="register-card">
      <h2>用户注册</h2>
      
      <form @submit.prevent="handleRegister">
        <div class="form-row">
          <div class="form-group">
            <label for="username">用户名 *</label>
            <input
              id="username"
              v-model="registerForm.username"
              type="text"
              placeholder="3-50 个字符"
              :disabled="loading"
            />
          </div>

          <div class="form-group">
            <label for="email">邮箱</label>
            <input
              id="email"
              v-model="registerForm.email"
              type="email"
              placeholder="example@email.com"
              :disabled="loading"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="password">密码 *</label>
            <input
              id="password"
              v-model="registerForm.password"
              type="password"
              placeholder="至少 8 位"
              :disabled="loading"
            />
          </div>

          <div class="form-group">
            <label for="confirmPassword">确认密码 *</label>
            <input
              id="confirmPassword"
              v-model="confirmPassword"
              type="password"
              placeholder="再次输入密码"
              :disabled="loading"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="real_name">真实姓名</label>
            <input
              id="real_name"
              v-model="registerForm.real_name"
              type="text"
              placeholder="选填"
              :disabled="loading"
            />
          </div>

          <div class="form-group">
            <label for="school">学校</label>
            <input
              id="school"
              v-model="registerForm.school"
              type="text"
              placeholder="选填"
              :disabled="loading"
            />
          </div>
        </div>

        <div v-if="errorMsg" class="error-message">
          {{ errorMsg }}
        </div>

        <div v-if="successMsg" class="success-message">
          {{ successMsg }}
        </div>

        <button type="submit" :disabled="loading" class="register-btn">
          {{ loading ? '注册中...' : '注册' }}
        </button>
      </form>

      <div class="register-footer">
        <router-link to="/login">已有账号？立即登录</router-link>
      </div>
    </div>
  </div>
</template>

<style scoped>
.register-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
}

.register-card {
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  width: 100%;
  max-width: 500px;
}

.register-card h2 {
  text-align: center;
  margin-bottom: 30px;
  color: #333;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #555;
}

.form-group input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
}

.error-message {
  color: #e74c3c;
  font-size: 14px;
  margin-bottom: 16px;
  padding: 10px;
  background: #fdf0ed;
  border-radius: 6px;
}

.success-message {
  color: #27ae60;
  font-size: 14px;
  margin-bottom: 16px;
  padding: 10px;
  background: #edfdf0;
  border-radius: 6px;
}

.register-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.3s;
}

.register-btn:hover:not(:disabled) {
  opacity: 0.9;
}

.register-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.register-footer {
  text-align: center;
  margin-top: 20px;
}

.register-footer a {
  color: #667eea;
  text-decoration: none;
}

@media (max-width: 500px) {
  .form-row {
    grid-template-columns: 1fr;
  }
}
</style>
```

---

## 7. 权限验证组件

### 7.1 路由守卫

创建 `src/router/guards.ts`：

```typescript
import type { Router, RouteLocationNormalized } from 'vue-router'
import { useAuthStore } from '@/stores/auth'

/** 需要登录的路由白名单 */
const whiteList = ['/login', '/register', '/forgot-password']

export function setupRouteGuards(router: Router) {
  router.beforeEach(async (to: RouteLocationNormalized, from: RouteLocationNormalized) => {
    const authStore = useAuthStore()

    // 白名单路由直接放行
    if (whiteList.includes(to.path)) {
      // 如果已登录，跳转到首页
      if (authStore.isLoggedIn && to.path === '/login') {
        return { path: '/' }
      }
      return true
    }

    // 检查是否登录
    if (!authStore.isLoggedIn) {
      return {
        path: '/login',
        query: { redirect: to.fullPath }
      }
    }

    // 检查管理员权限
    if (to.meta.requiresAdmin && !authStore.isAdmin) {
      return { path: '/403' }
    }

    return true
  })
}
```

### 7.2 路由配置示例

创建 `src/router/index.ts`：

```typescript
import { createRouter, createWebHistory } from 'vue-router'
import { setupRouteGuards } from './guards'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/login',
      name: 'Login',
      component: () => import('@/views/LoginView.vue'),
      meta: { title: '登录' }
    },
    {
      path: '/register',
      name: 'Register',
      component: () => import('@/views/RegisterView.vue'),
      meta: { title: '注册' }
    },
    {
      path: '/',
      name: 'Home',
      component: () => import('@/views/HomeView.vue'),
      meta: { title: '首页', requiresAuth: true }
    },
    {
      path: '/profile',
      name: 'Profile',
      component: () => import('@/views/ProfileView.vue'),
      meta: { title: '个人中心', requiresAuth: true }
    },
    {
      path: '/admin',
      name: 'Admin',
      component: () => import('@/views/AdminView.vue'),
      meta: { title: '管理后台', requiresAuth: true, requiresAdmin: true }
    },
    {
      path: '/403',
      name: 'Forbidden',
      component: () => import('@/views/ForbiddenView.vue'),
      meta: { title: '无权限' }
    }
  ]
})

// 设置路由守卫
setupRouteGuards(router)

export default router
```

### 7.3 权限指令

创建 `src/directives/permission.ts`：

```typescript
import type { Directive, DirectiveBinding } from 'vue'
import { useAuthStore } from '@/stores/auth'

/** v-permission 指令 - 用于控制元素显示 */
export const permissionDirective: Directive = {
  mounted(el: HTMLElement, binding: DirectiveBinding<string | string[]>) {
    const authStore = useAuthStore()
    const requiredRoles = Array.isArray(binding.value) ? binding.value : [binding.value]

    if (!requiredRoles.includes(authStore.user?.role || '')) {
      el.parentNode?.removeChild(el)
    }
  }
}

/** v-auth 指令 - 检查是否已登录 */
export const authDirective: Directive = {
  mounted(el: HTMLElement) {
    const authStore = useAuthStore()

    if (!authStore.isLoggedIn) {
      el.parentNode?.removeChild(el)
    }
  }
}
```

注册指令（`main.ts`）：

```typescript
import { createApp } from 'vue'
import App from './App.vue'
import { permissionDirective, authDirective } from './directives/permission'

const app = createApp(App)

app.directive('permission', permissionDirective)
app.directive('auth', authDirective)

app.mount('#app')
```

使用示例：

```vue
<template>
  <!-- 仅管理员可见 -->
  <button v-permission="'admin'">管理后台</button>

  <!-- 仅登录用户可见 -->
  <div v-auth>
    欢迎回来，{{ username }}
  </div>

  <!-- 管理员或超级管理员可见 -->
  <button v-permission="['admin', 'super_admin']">高级设置</button>
</template>
```

### 7.4 权限组合式函数

创建 `src/composables/usePermission.ts`：

```typescript
import { computed } from 'vue'
import { useAuthStore } from '@/stores/auth'

export function usePermission() {
  const authStore = useAuthStore()

  /** 检查是否拥有指定角色 */
  const hasRole = (role: string | string[]): boolean => {
    const roles = Array.isArray(role) ? role : [role]
    return roles.includes(authStore.user?.role || '')
  }

  /** 是否为管理员 */
  const isAdmin = computed(() => authStore.isAdmin)

  /** 是否已登录 */
  const isLoggedIn = computed(() => authStore.isLoggedIn)

  /** 当前用户 */
  const currentUser = computed(() => authStore.user)

  return {
    hasRole,
    isAdmin,
    isLoggedIn,
    currentUser
  }
}
```

使用示例：

```vue
<script setup lang="ts">
import { usePermission } from '@/composables/usePermission'

const { isAdmin, isLoggedIn, hasRole, currentUser } = usePermission()
</script>

<template>
  <div v-if="isLoggedIn">
    <p>欢迎，{{ currentUser?.username }}</p>
    <button v-if="isAdmin">管理设置</button>
    <button v-if="hasRole(['editor', 'admin'])">编辑内容</button>
  </div>
</template>
```

---

## 8. 错误处理

### 8.1 错误码对照表

| HTTP 状态码 | 业务含义 | 前端处理建议 |
|------------|---------|-------------|
| 200 | 请求成功 | 正常处理响应数据 |
| 400 | 请求参数错误 | 显示错误提示 |
| 401 | 未认证 / Token 过期 | 清除登录状态，跳转登录页 |
| 403 | 权限不足 | 显示无权限提示或跳转 403 页面 |
| 404 | 资源不存在 | 显示 404 页面 |
| 422 | 参数验证失败 | 显示具体验证错误 |
| 500 | 服务器内部错误 | 显示系统错误提示 |

### 8.2 全局错误处理

```typescript
// src/utils/errorHandler.ts
import { ElMessage } from 'element-plus' // 或其他 UI 库

export function handleApiError(error: any): void {
  const status = error.response?.status
  const message = error.response?.data?.message || '请求失败'

  switch (status) {
    case 400:
      ElMessage.error(message)
      break
    case 401:
      ElMessage.warning('登录已过期，请重新登录')
      break
    case 403:
      ElMessage.error('您没有权限执行此操作')
      break
    case 422:
      const detail = error.response?.data?.detail
      if (Array.isArray(detail)) {
        detail.forEach((err: any) => {
          ElMessage.error(`${err.loc?.join('.')}：${err.msg}`)
        })
      } else {
        ElMessage.error(message)
      }
      break
    case 500:
      ElMessage.error('服务器错误，请稍后重试')
      break
    default:
      ElMessage.error(message)
  }
}
```

---

## 附录：快速集成清单

### ✅ 必需文件

```
src/
├── api/
│   └── auth.ts              # API 封装
├── types/
│   └── auth.ts              # TypeScript 类型
├── stores/
│   └── auth.ts              # Pinia 状态管理
├── utils/
│   └── request.ts           # Axios 实例
├── router/
│   ├── index.ts             # 路由配置
│   └── guards.ts            # 路由守卫
├── views/
│   ├── LoginView.vue        # 登录页
│   └── RegisterView.vue     # 注册页
├── composables/
│   └── usePermission.ts     # 权限组合式函数
└── directives/
    └── permission.ts        # 权限指令
```

### ✅ 环境变量

```env
VITE_API_BASE_URL=http://localhost:8000
VITE_API_PREFIX=/api/v1
```

### ✅ 依赖包

```json
{
  "dependencies": {
    "axios": "^1.6.0",
    "pinia": "^2.1.0",
    "vue-router": "^4.2.0"
  }
}
```

---

**文档版本**: 1.1  
**最后更新**: 2026-02-14  
**后端 API 版本**: v1
