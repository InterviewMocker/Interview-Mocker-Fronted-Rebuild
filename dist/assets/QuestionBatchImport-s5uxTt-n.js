import{c as l,a as t,o as n,d as ee,l as te,D as se,i as v,f,n as D,g as k,E as ae,t as c,p as y,x as M,G as oe,F as Q,h as T,u as re,b as le,q as m,m as $,y as B,v as q}from"./index-B1_3jWiP.js";import{j as A,k as ne,m as ie,n as de}from"./question-DTEubUy6.js";import{r as ue}from"./ArrowLeftIcon-B7O66r4f.js";import{r as R}from"./DocumentTextIcon-CYhgIdGt.js";import{r as ce}from"./CloudArrowUpIcon-ClIo6N5m.js";import{r as pe}from"./CheckCircleIcon-3dtCnVgF.js";import{r as ve}from"./PlusIcon-OubMv-v3.js";import{r as me}from"./TrashIcon-dWnjABfe.js";function ge(L,C){return n(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"})])}const fe={class:"min-h-screen bg-gray-950 text-white p-6 lg:p-8"},he={class:"max-w-6xl mx-auto space-y-6"},ye={class:"flex items-center gap-4"},xe={class:"flex border-b border-gray-800"},be={class:"flex items-center gap-2"},_e={class:"flex items-center gap-2"},we={key:0,class:"bg-red-900/20 border border-red-800 text-red-400 px-4 py-3 rounded-lg flex items-center gap-2"},ke={key:1,class:"space-y-6"},Ce={key:0,class:"inline-flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-lg text-emerald-400 mb-4"},Ie={key:1},Se=["disabled"],$e={key:1,class:"bg-gray-900 border border-gray-800 rounded-xl p-8 text-center"},Ee={class:"animate-pulse space-y-4"},Ve={class:"h-2 bg-gray-700 rounded-full max-w-md mx-auto overflow-hidden"},Ue={class:"text-gray-500 text-sm"},De={key:2,class:"space-y-4"},Me={class:"flex items-center justify-between"},Qe={class:"text-lg font-medium text-white"},Te={class:"flex items-center gap-3"},Be={class:"flex items-center gap-2 text-sm text-gray-400 cursor-pointer"},Fe=["checked"],ze=["disabled"],Ne={class:"grid gap-4"},je=["onClick"],qe={class:"flex items-start gap-3"},Ae={class:"pt-1"},Re=["checked"],Le={class:"flex-1 space-y-2"},We={class:"flex items-center gap-2"},Ze={class:"text-emerald-400 text-sm font-bold"},Ge={class:"text-gray-400 text-sm"},He={class:"text-gray-400 text-sm"},Je={class:"font-medium text-white"},Oe={class:"text-gray-400 text-sm line-clamp-2"},Pe={key:0,class:"text-gray-500 text-sm bg-gray-900/50 p-2 rounded"},Ke={class:"flex flex-wrap gap-2"},Xe={key:3,class:"bg-emerald-900/20 border border-emerald-800 rounded-xl p-8 text-center"},Ye={key:2,class:"space-y-6"},et={class:"space-y-4"},tt=["onClick"],st={class:"grid md:grid-cols-12 gap-4"},at={class:"md:col-span-8 space-y-2"},ot=["onUpdate:modelValue"],rt={class:"md:col-span-2 space-y-2"},lt=["onUpdate:modelValue"],nt={class:"md:col-span-2 space-y-2"},it=["onUpdate:modelValue"],dt=["onUpdate:modelValue"],ut=["onUpdate:modelValue"],ct={class:"flex items-center justify-between pt-4"},pt={class:"flex gap-4"},vt=["disabled"],kt=ee({__name:"QuestionBatchImport",setup(L){const C=re(),h=le().query.bank_id,I=m("file"),p=m(!1),g=m(null),F=m(null),b=m(null),E=m(0),i=m("idle"),_=m(null),u=m([]),d=m(new Set);let w=null;function W(){var a;(a=F.value)==null||a.click()}function z(a){const e=a.target;e.files&&e.files.length>0&&(b.value=e.files[0],g.value=null)}async function Z(){if(!b.value||!h)return;p.value=!0,i.value="uploading",g.value=null,u.value=[];const a=new FormData;a.append("file",b.value),a.append("bank_id",h);try{const e=await de(a);if(!e.ok)throw new Error(`Upload failed: ${e.statusText}`);if(!e.body)throw new Error("No response body");i.value="processing",w=e.body.getReader();const s=new TextDecoder;let o="";for(;;){const{done:r,value:V}=await w.read();if(r)break;o+=s.decode(V,{stream:!0});const N=o.split(`
`);o=N.pop()||"";let j="";for(const S of N)if(S.trim()!==""){if(S.startsWith("event: "))j=S.slice(7).trim();else if(S.startsWith("data: "))try{const U=JSON.parse(S.slice(6));G(j,U)}catch(U){console.error("Failed to parse SSE data:",U)}}}}catch(e){console.error("Extraction error:",e),g.value=e.message||"Extraction failed",i.value="idle"}finally{p.value=!1,w&&w.releaseLock()}}function G(a,e){switch(a){case"task_created":_.value=e.task_id,localStorage.setItem("current_extraction_task",e.task_id);break;case"chunk_progress":if(E.value=e.progress,e.new_questions){u.value.push(...e.new_questions);const s=u.value.length-e.new_questions.length;for(let o=0;o<e.new_questions.length;o++)d.value.add(s+o)}break;case"completed":i.value="review",e.questions&&(u.value=e.questions,d.value=new Set(e.questions.map((s,o)=>o))),localStorage.removeItem("current_extraction_task");break;case"error":g.value=e.message,e.partial_questions?(u.value=e.partial_questions,i.value="review"):i.value="idle";break}}function H(a){d.value.has(a)?d.value.delete(a):d.value.add(a)}function J(){d.value.size===u.value.length?d.value.clear():u.value.forEach((a,e)=>d.value.add(e))}async function O(){if(!(!_.value||!h||d.value.size===0)){p.value=!0,i.value="importing";try{await ne({task_id:_.value,bank_id:h,question_indices:Array.from(d.value)}),i.value="completed",setTimeout(()=>{C.push(`/questions/banks/${h}`)},1500)}catch(a){g.value=a.message||"Import failed",i.value="review"}finally{p.value=!1}}}const x=m([{title:"",content:"",type:"technical",difficulty:"medium",difficulty_score:5,tags:[],reference_answer:"",answer_key_points:[]}]);function P(){x.value.push({title:"",content:"",type:"technical",difficulty:"medium",difficulty_score:5,tags:[],reference_answer:"",answer_key_points:[]})}function K(a){x.value.length>1&&x.value.splice(a,1)}async function X(){const a=x.value.filter(e=>e.title&&e.content);if(a.length===0){g.value="请至少填写一道完整的题目";return}p.value=!0;try{await ie({bank_id:h,questions:a}),C.push(`/questions/banks/${h}`)}catch(e){g.value=e.message||"Batch creation failed"}finally{p.value=!1}}te(async()=>{if(!h){g.value="缺少题库ID参数";return}const a=localStorage.getItem("current_extraction_task");if(a)try{const s=(await A(a)).data;s.status==="processing"?(_.value=s.task_id,i.value="processing",Y(s.task_id)):s.status==="completed"&&s.questions&&(_.value=s.task_id,u.value=s.questions,i.value="review",d.value=new Set(s.questions.map((o,r)=>r)))}catch(e){console.error("Failed to restore task",e),localStorage.removeItem("current_extraction_task")}});async function Y(a){const e=setInterval(async()=>{try{const o=(await A(a)).data;(o.status==="completed"||o.status==="failed")&&(clearInterval(e),_.value=o.task_id,o.questions&&(u.value=o.questions),i.value=o.status==="completed"?"review":"idle",o.status==="completed"&&(d.value=new Set((o.questions||[]).map((r,V)=>V)),localStorage.removeItem("current_extraction_task"))),E.value=o.progress}catch{clearInterval(e)}},2e3)}return se(()=>{w&&w.cancel()}),(a,e)=>(n(),l("div",fe,[t("div",he,[t("div",ye,[t("button",{onClick:e[0]||(e[0]=s=>v(C).back()),class:"p-2 rounded-lg hover:bg-gray-900 text-gray-400 hover:text-white transition-colors"},[f(v(ue),{class:"w-5 h-5"})]),e[5]||(e[5]=t("div",null,[t("h1",{class:"text-2xl font-bold"},"导入题目"),t("p",{class:"text-gray-400 text-sm"},"批量导入或创建题目到题库")],-1))]),t("div",xe,[t("button",{onClick:e[1]||(e[1]=s=>I.value="file"),class:D(["px-6 py-3 font-medium text-sm transition-colors border-b-2",I.value==="file"?"border-emerald-500 text-emerald-400":"border-transparent text-gray-400 hover:text-white"])},[t("div",be,[f(v(R),{class:"w-5 h-5"}),e[6]||(e[6]=k(" 智能文件提取 ",-1))])],2),t("button",{onClick:e[2]||(e[2]=s=>I.value="manual"),class:D(["px-6 py-3 font-medium text-sm transition-colors border-b-2",I.value==="manual"?"border-emerald-500 text-emerald-400":"border-transparent text-gray-400 hover:text-white"])},[t("div",_e,[f(v(ae),{class:"w-5 h-5"}),e[7]||(e[7]=k(" 批量手动录入 ",-1))])],2)]),g.value?(n(),l("div",we,[f(v(ge),{class:"w-5 h-5 flex-shrink-0"}),t("span",null,c(g.value),1)])):y("",!0),I.value==="file"?(n(),l("div",ke,[i.value==="idle"||i.value==="uploading"?(n(),l("div",{key:0,class:"border-2 border-dashed border-gray-700 rounded-xl p-10 text-center hover:border-emerald-500/50 hover:bg-gray-900/50 transition-all cursor-pointer",onClick:W,onDragover:e[3]||(e[3]=M(()=>{},["prevent"])),onDrop:M(z,["prevent"])},[t("input",{type:"file",ref_key:"fileInput",ref:F,class:"hidden",accept:".txt,.md,.docx,.pdf",onChange:z},null,544),f(v(ce),{class:"w-12 h-12 mx-auto text-gray-500 mb-4"}),e[8]||(e[8]=t("h3",{class:"text-lg font-medium text-white mb-2"},"点击或拖拽上传文件",-1)),e[9]||(e[9]=t("p",{class:"text-gray-400 text-sm mb-6"},"支持 .txt, .md, .docx, .pdf (最大 50MB)",-1)),b.value?(n(),l("div",Ce,[f(v(R),{class:"w-5 h-5"}),k(" "+c(b.value.name),1)])):y("",!0),b.value?(n(),l("div",Ie,[t("button",{onClick:M(Z,["stop"]),disabled:p.value,class:"px-6 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium shadow-lg shadow-emerald-500/20 transition-all disabled:opacity-50"},c(p.value?"上传解析中...":"开始智能提取"),9,Se)])):y("",!0)],32)):i.value==="processing"?(n(),l("div",$e,[t("div",Ee,[t("div",Ve,[t("div",{class:"h-full bg-emerald-500 transition-all duration-300",style:oe({width:`${E.value}%`})},null,4)]),e[10]||(e[10]=t("p",{class:"text-emerald-400 font-medium"},"正在通过 AI 智能分析题目...",-1)),t("p",Ue,"已提取 "+c(u.value.length)+" 道题目",1)])])):y("",!0),(i.value==="processing"||i.value==="review")&&u.value.length>0?(n(),l("div",De,[t("div",Me,[t("h3",Qe,"提取结果预览 ("+c(u.value.length)+")",1),t("div",Te,[t("label",Be,[t("input",{type:"checkbox",checked:d.value.size===u.value.length,onChange:J,class:"rounded bg-gray-800 border-gray-700 text-emerald-500 focus:ring-emerald-500/20"},null,40,Fe),e[11]||(e[11]=k(" 全选 ",-1))]),t("button",{onClick:O,disabled:p.value||d.value.size===0,class:"px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium transition-colors disabled:opacity-50"}," 导入选中题目 ("+c(d.value.size)+") ",9,ze)])]),t("div",Ne,[(n(!0),l(Q,null,T(u.value,(s,o)=>(n(),l("div",{key:o,class:D(["p-4 rounded-xl border transition-all cursor-pointer",d.value.has(o)?"bg-emerald-900/10 border-emerald-500/50":"bg-gray-900 border-gray-800 hover:border-gray-700"]),onClick:r=>H(o)},[t("div",qe,[t("div",Ae,[t("input",{type:"checkbox",checked:d.value.has(o),readonly:"",class:"rounded bg-gray-800 border-gray-700 text-emerald-500 focus:ring-emerald-500/20"},null,8,Re)]),t("div",Le,[t("div",We,[t("span",Ze,"["+c(s.type)+"]",1),t("span",Ge,"难度: "+c(s.difficulty),1),t("span",He,"分数: "+c(s.difficulty_score),1)]),t("h4",Je,c(s.title),1),t("p",Oe,c(s.content),1),s.reference_answer?(n(),l("div",Pe,[e[12]||(e[12]=t("span",{class:"text-gray-400"},"参考答案:",-1)),k(" "+c(s.reference_answer),1)])):y("",!0),t("div",Ke,[(n(!0),l(Q,null,T(s.tags,r=>(n(),l("span",{key:r,class:"text-xs px-2 py-0.5 bg-gray-800 rounded text-gray-400"},c(r),1))),128))])])])],10,je))),128))])])):y("",!0),i.value==="completed"?(n(),l("div",Xe,[f(v(pe),{class:"w-16 h-16 mx-auto text-emerald-500 mb-4"}),e[13]||(e[13]=t("h3",{class:"text-xl font-bold text-white mb-2"},"导入成功!",-1)),e[14]||(e[14]=t("p",{class:"text-emerald-400"},"题目已成功添加到题库",-1))])):y("",!0)])):(n(),l("div",Ye,[t("div",et,[(n(!0),l(Q,null,T(x.value,(s,o)=>(n(),l("div",{key:o,class:"bg-gray-900 border border-gray-800 rounded-xl p-6 space-y-4 relative group"},[x.value.length>1?(n(),l("button",{key:0,onClick:r=>K(o),class:"absolute top-4 right-4 text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"},[f(v(me),{class:"w-5 h-5"})],8,tt)):y("",!0),t("div",st,[t("div",at,[$(t("input",{"onUpdate:modelValue":r=>s.title=r,placeholder:"题目标题",class:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-emerald-500"},null,8,ot),[[B,s.title]])]),t("div",rt,[$(t("select",{"onUpdate:modelValue":r=>s.type=r,class:"w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-emerald-500"},[...e[15]||(e[15]=[t("option",{value:"technical"},"技术题",-1),t("option",{value:"scenario"},"场景题",-1),t("option",{value:"algorithm"},"算法题",-1),t("option",{value:"behavioral"},"行为题",-1)])],8,lt),[[q,s.type]])]),t("div",nt,[$(t("select",{"onUpdate:modelValue":r=>s.difficulty=r,class:"w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-emerald-500"},[...e[16]||(e[16]=[t("option",{value:"easy"},"简单",-1),t("option",{value:"medium"},"中等",-1),t("option",{value:"hard"},"困难",-1)])],8,it),[[q,s.difficulty]])])]),$(t("textarea",{"onUpdate:modelValue":r=>s.content=r,rows:"3",placeholder:"题目详细内容...",class:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-emerald-500"},null,8,dt),[[B,s.content]]),$(t("textarea",{"onUpdate:modelValue":r=>s.reference_answer=r,rows:"2",placeholder:"参考答案 (可选)...",class:"w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-emerald-500"},null,8,ut),[[B,s.reference_answer]])]))),128))]),t("div",ct,[t("button",{onClick:P,class:"flex items-center gap-2 px-4 py-2 text-emerald-400 hover:text-emerald-300 hover:bg-emerald-900/20 rounded-lg transition-colors"},[f(v(ve),{class:"w-5 h-5"}),e[17]||(e[17]=k(" 添加下一题 ",-1))]),t("div",pt,[t("button",{onClick:e[4]||(e[4]=s=>v(C).back()),class:"px-6 py-2.5 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700"}," 取消 "),t("button",{onClick:X,disabled:p.value,class:"px-6 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium shadow-lg shadow-emerald-500/20 transition-all disabled:opacity-50"},c(p.value?"提交中...":`批量提交 (${x.value.length})`),9,vt)])])]))])]))}});export{kt as default};
